<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="墨筝写字的地方，聊聊技术，见闻和思考">
  <meta name="keyword" content="software development, programming, technology">
  
    <link rel="shortcut icon" href="/css/images/logo.jpg">
  
  <title>
    
      React-scan 是如何检测性能的 | 墨筝
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SLTXCE1YRJ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-SLTXCE1YRJ');
    </script>

  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 7.3.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.jpg" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>墨筝</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/series/" class="item-link">Series</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/series/" class="menu-link">Series</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>React-scan 是如何检测性能的</h2>
  <p class="post-date">2025-01-27</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a target="_blank" rel="noopener" href="https://github.com/aidenybai/react-scan">react-scan</a> 是 React 社区中最近热度很高的一个项目，在 github 上目前已经获得了 12.5k 的 star 量，主要用于自动检测 React 应用的性能问题(核心是组件的渲染性能)。针对该问题，之前社区中也有一些类似方案，但各自存在一些使用上的缺陷，比如：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://react.dev/reference/react/Profiler">React Profiler</a>，React 官方提供的编码式性能检测方案，开发者可以在 onRender 函数中获取到应用渲染的性能数据，但缺陷是对应用源代码的侵入性较强，需要开发者额外处理生成环境的禁用，且开发者需要自行分析出可能的性能问题。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/welldone-software/why-did-you-render">Why did you render</a>, 其作者现已加入 React 团队，该工具通过检测应用的 re-render 原因来帮助开发者排查一些不必要的 re-render, 提供了工程化的接入方式，但缺陷是在性能可视化方面做的比较一般。</li>
<li><a target="_blank" rel="noopener" href="https://legacy.reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html">React Devtools</a>，React 官方推出的一款开发者工具(浏览器插件)，可以通过其 profiler tab 来查看性能数据，但缺陷是缺少可编程的对外 API，无法做一些自定义的操作，同时也无法直观的看出哪些组件有问题。</li>
</ul>
<p>相比上述方案，<a target="_blank" rel="noopener" href="https://github.com/aidenybai/react-scan">react-scan</a> 提供了更加低成本的接入方式，更为灵活的可编程 API 以及更高效的性能数据可视化方式，让开发者可以快速 get 到哪些组件需要进行性能优化。</p>
<h2 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h2><h3 id="编程式接入"><a href="#编程式接入" class="headerlink" title="编程式接入"></a>编程式接入</h3><ol>
<li>安装依赖<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i react-scan</span><br></pre></td></tr></table></figure></li>
<li>编码引入<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 React 之前引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; scan &#125; <span class="keyword">from</span> <span class="string">&#x27;react-scan&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  <span class="title function_">scan</span>(&#123;</span><br><span class="line">    <span class="attr">enabled</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// logs render info to console (default: false)</span></span><br><span class="line">    <span class="attr">log</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="命令行使用"><a href="#命令行使用" class="headerlink" title="命令行使用"></a>命令行使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx react-scan@latest http://localhost:3000(your website url)</span><br></pre></td></tr></table></figure>

<h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><p><img src="https://raw.githubusercontent.com/aidenybai/react-scan/refs/heads/main/.github/assets/demo.gif"></p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>React-scan 的实现可分为两步，第一步是获取到 React 组件的渲染数据，第二步则是处理和分析数据，然后再通过一种高效的可视化和交互方式让开发者可以快速感知到 where the problem exists.</p>
<h3 id="获取渲染数据"><a href="#获取渲染数据" class="headerlink" title="获取渲染数据"></a>获取渲染数据</h3><p>React 并未提供外部 API 可以获取组件的渲染或更新过程中的相关信息，因此，想要获取这部分数据，就必须能够切入到 React 内部的执行流程，React-scan 通过 <a target="_blank" rel="noopener" href="https://github.com/aidenybai/bippy">bippy</a> 这个库实现了这一点。而 bippy 的实现原理也并不复杂，它主要通过植入自定义的 <code>__REACT_DEVTOOLS_GLOBAL_HOOK__</code> 来获取到 React 执行过程中的相关信息。</p>
<p>具体来说，React-dom 在执行过程中会检测全局对象中是否存在 <code>__REACT_DEVTOOLS_GLOBAL_HOOK__</code> 这个对象，如果存在，React-dom 将会把该对象注入到内部钩子，概要代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">injectInternals</span>(<span class="params">internals</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> __REACT_DEVTOOLS_GLOBAL_HOOK__ === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> hook = __REACT_DEVTOOLS_GLOBAL_HOOK__;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    rendererID = hook.<span class="title function_">inject</span>(internals); </span><br><span class="line">    injectedHook = hook;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>React-scan 通过 <a target="_blank" rel="noopener" href="https://github.com/aidenybai/bippy">bippy</a> 植入 <code>__REACT_DEVTOOLS_GLOBAL_HOOK__</code> 的实现代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// __REACT_DEVTOOLS_GLOBAL_HOOK__ 必须在 React 运行时之前植入</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isClientEnvironment</span>()) &#123;</span><br><span class="line">    <span class="title function_">getRDTHook</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getRDTHook = (</span><br><span class="line">  <span class="attr">onActive</span>?: <span class="function">() =&gt;</span> <span class="built_in">unknown</span>,</span><br><span class="line">): <span class="function"><span class="params">ReactDevToolsGlobalHook</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">hasRDTHook</span>()) &#123;</span><br><span class="line">    <span class="comment">// 植入自定义 hook</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">installRDTHook</span>(onActive);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">patchRDTHook</span>(onActive);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> globalThis.<span class="property">__REACT_DEVTOOLS_GLOBAL_HOOK__</span> <span class="keyword">as</span> <span class="title class_">ReactDevToolsGlobalHook</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> installRDTHook = (</span><br><span class="line">  <span class="attr">onActive</span>?: <span class="function">() =&gt;</span> <span class="built_in">unknown</span>,</span><br><span class="line">): <span class="function"><span class="params">ReactDevToolsGlobalHook</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> renderers = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">number</span>, <span class="title class_">ReactRenderer</span>&gt;();</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">rdtHook</span>: <span class="title class_">ReactDevToolsGlobalHook</span> = &#123;</span><br><span class="line">    checkDCE,</span><br><span class="line">    <span class="attr">supportsFiber</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">supportsFlight</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hasUnsupportedRendererAttached</span>: <span class="literal">false</span>,</span><br><span class="line">    renderers,</span><br><span class="line">    <span class="attr">onCommitFiberRoot</span>: <span class="variable constant_">NO_OP</span>,</span><br><span class="line">    <span class="attr">onCommitFiberUnmount</span>: <span class="variable constant_">NO_OP</span>,</span><br><span class="line">    <span class="attr">onPostCommitFiberRoot</span>: <span class="variable constant_">NO_OP</span>,</span><br><span class="line">    <span class="title function_">inject</span>(<span class="params">renderer</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextID = ++i;</span><br><span class="line">      renderers.<span class="title function_">set</span>(nextID, renderer);</span><br><span class="line">      <span class="keyword">if</span> (!rdtHook.<span class="property">_instrumentationIsActive</span>) &#123;</span><br><span class="line">        rdtHook.<span class="property">_instrumentationIsActive</span> = <span class="literal">true</span>;</span><br><span class="line">        onActiveListeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> <span class="title function_">listener</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> nextID;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">_instrumentationSource</span>: <span class="variable constant_">BIPPY_INSTRUMENTATION_STRING</span>,</span><br><span class="line">    <span class="attr">_instrumentationIsActive</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">objectDefineProperty</span>(globalThis, <span class="string">&#x27;__REACT_DEVTOOLS_GLOBAL_HOOK__&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">value</span>: rdtHook,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> rdtHook;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当 React 组件树在 commit 阶段执行渲染或更新 dom 时，React 会执行内部的 <code>onCommitRoot</code> 生命周期方法，而该方法在运行时则会去检测并执行上述 hook 对象中的 <code>onCommitFiberRoot</code> 方法，概要代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">onCommitRoot</span>(<span class="params">root, priorityLevel</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (injectedHook &amp;&amp; <span class="keyword">typeof</span> injectedHook.<span class="property">onCommitFiberRoot</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      injectedHook.<span class="title function_">onCommitFiberRoot</span>(rendererID, root, priorityLevel, didError);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，只要在植入的 <code>__REACT_DEVTOOLS_GLOBAL_HOOK__</code> 对象中实现自己的 <code>onCommitFiberRoot</code> 方法，即可拿到相关的渲染信息并执行一些自己的定制化逻辑。React-scan 就是这么干的，它在 <code>onCommitFiberRoot</code> 方法中进行了 fiber 树的递归遍历，并传入自定义的 <code>handleRender</code> 方法，每个需要更新的 fiberNode 在渲染时会执行该方法，概要代码如下所示：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onCommitFiberRoot</span> = (<span class="params"><span class="attr">rendererID</span>: <span class="built_in">number</span>, <span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (instrumentation.<span class="property">isPaused</span>.<span class="property">value</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="title function_">onCommitStart</span>();</span><br><span class="line">  <span class="keyword">if</span> (root) &#123;</span><br><span class="line">    instrumentation.<span class="property">fiberRoots</span>.<span class="title function_">add</span>(root);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归遍历 fiber 树,递归的逻辑这里不展开</span></span><br><span class="line">  <span class="title function_">traverseRenderedFibers</span>(root, handleRender);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCommitFinish</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中 <code>handleRender</code> 方法的实现如下所示（关键逻辑已添加注释）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleRender</span> = (<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">type</span> = <span class="title function_">getType</span>(fiber.<span class="property">type</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">type</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isValidFiber</span>(fiber)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 计算 props 类型更新</span></span><br><span class="line">  <span class="keyword">const</span> propsRender = <span class="title function_">getPropsRender</span>(fiber, <span class="keyword">type</span>);</span><br><span class="line">  <span class="comment">// 计算 context 类型更新</span></span><br><span class="line">  <span class="keyword">const</span> contextRender = <span class="title function_">getContextRender</span>(fiber, <span class="keyword">type</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> trigger = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// alternate 属性主要用于调和过程中链接到老的 fiberNode</span></span><br><span class="line">  <span class="comment">// 这里用于判断是否为 state 变化带来的 re-render</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">alternate</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> didStateChange = <span class="title function_">traverseState</span>(fiber, <span class="function">(<span class="params">prevState, nextState</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> !<span class="title class_">Object</span>.<span class="title function_">is</span>(prevState.<span class="property">memoizedState</span>, nextState.<span class="property">memoizedState</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (didStateChange) &#123;</span><br><span class="line">      trigger = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> name = <span class="title function_">getDisplayName</span>(<span class="keyword">type</span>);</span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">&#x27;Million(Profiler)&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="attr">renders</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Render</span>&gt; = [];</span><br><span class="line">  <span class="comment">// props 变化引起的更新</span></span><br><span class="line">  <span class="keyword">if</span> (propsRender) &#123;</span><br><span class="line">    propsRender.<span class="property">trigger</span> = trigger;</span><br><span class="line">    renders.<span class="title function_">push</span>(propsRender);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// context 变化引起的更新</span></span><br><span class="line">  <span class="keyword">if</span> (contextRender) &#123;</span><br><span class="line">    contextRender.<span class="property">trigger</span> = trigger;</span><br><span class="line">    renders.<span class="title function_">push</span>(contextRender);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> &#123; selfTime &#125; = <span class="title function_">getTimings</span>(fiber);</span><br><span class="line">  <span class="comment">// state 变化引起的更新</span></span><br><span class="line">  <span class="keyword">if</span> (trigger) &#123;</span><br><span class="line">    renders.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;state&#x27;</span>,</span><br><span class="line">      <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">      trigger,</span><br><span class="line">      <span class="attr">changes</span>: [],</span><br><span class="line">      <span class="attr">name</span>: <span class="title function_">getDisplayName</span>(<span class="keyword">type</span>),</span><br><span class="line">      <span class="attr">time</span>: selfTime,</span><br><span class="line">      <span class="attr">forget</span>: <span class="title function_">hasMemoCache</span>(fiber),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!propsRender &amp;&amp; !contextRender &amp;&amp; !trigger) &#123;</span><br><span class="line">    <span class="comment">// 非 props,context 以及 state 变化带来的更新</span></span><br><span class="line">    <span class="comment">// 诸如通过调用 forceUpdate 带来的强制更新</span></span><br><span class="line">    renders.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;misc&#x27;</span>,</span><br><span class="line">      <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">      trigger,</span><br><span class="line">      <span class="attr">changes</span>: [],</span><br><span class="line">      <span class="attr">name</span>: <span class="title function_">getDisplayName</span>(<span class="keyword">type</span>),</span><br><span class="line">      <span class="attr">time</span>: selfTime,</span><br><span class="line">      <span class="attr">forget</span>: <span class="title function_">hasMemoCache</span>(fiber),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 展示渲染数据</span></span><br><span class="line">  <span class="title function_">reportRender</span>(fiber, renders);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过上述代码可知，React-scan 在自定义注入的 <code>onCommitFiberRoot</code> 方法中进行了 fiber 树的遍历，并最终在 <code>handleRender</code> 方法内通过比较 props, context 以及 state 等操作，标记了多余的 re-render, 并算取了对应 fiberNode 的渲染数据，数据字段包括触发渲染的更新类型，渲染耗时等。</p>
<p>在 <code>handleRender</code> 中 React-scan 判断 props 和 context 更新以及执行相应的耗时计算实现如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> unstableTypes = [<span class="string">&#x27;function&#x27;</span>, <span class="string">&#x27;object&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getPropsRender = (<span class="attr">fiber</span>: <span class="title class_">Fiber</span>, <span class="attr">type</span>: <span class="title class_">Function</span>): <span class="title class_">Render</span> | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">changes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Change</span>&gt; = [];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// alternate 属性可链接到老的 fiberNode</span></span><br><span class="line">  <span class="keyword">const</span> prevProps = fiber.<span class="property">alternate</span>?.<span class="property">memoizedProps</span> || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> nextProps = fiber.<span class="property">memoizedProps</span> || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">new</span> <span class="title class_">Set</span>([</span><br><span class="line">    ...<span class="title class_">Object</span>.<span class="title function_">keys</span>(prevProps),</span><br><span class="line">    ...<span class="title class_">Object</span>.<span class="title function_">keys</span>(nextProps),</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> propName <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevValue = prevProps?.[propName];</span><br><span class="line">    <span class="keyword">const</span> nextValue = nextProps?.[propName];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">is</span>(prevValue, nextValue) ||</span><br><span class="line">      <span class="title class_">React</span>.<span class="title function_">isValidElement</span>(prevValue) ||</span><br><span class="line">      <span class="title class_">React</span>.<span class="title function_">isValidElement</span>(nextValue)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">change</span>: <span class="title class_">Change</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: propName,</span><br><span class="line">      prevValue,</span><br><span class="line">      nextValue,</span><br><span class="line">      <span class="attr">unstable</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    changes.<span class="title function_">push</span>(change);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevValueString = <span class="title function_">fastSerialize</span>(prevValue);</span><br><span class="line">    <span class="keyword">const</span> nextValueString = <span class="title function_">fastSerialize</span>(nextValue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !unstableTypes.<span class="title function_">includes</span>(<span class="keyword">typeof</span> prevValue) ||</span><br><span class="line">      !unstableTypes.<span class="title function_">includes</span>(<span class="keyword">typeof</span> nextValue) ||</span><br><span class="line">      prevValueString !== nextValueString</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是对象类型，则比较其序列化结果</span></span><br><span class="line">    <span class="comment">// 如果序列化结果比较值是相同，则说明其实该 re-render 是没必要的，通过 unstable 属性进行标记</span></span><br><span class="line">    change.<span class="property">unstable</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;props&#x27;</span>,</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">trigger</span>: <span class="literal">false</span>,</span><br><span class="line">    changes,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">getDisplayName</span>(<span class="keyword">type</span>),</span><br><span class="line">    <span class="attr">time</span>: <span class="title function_">getTimings</span>(fiber).<span class="property">selfTime</span>,</span><br><span class="line">    <span class="attr">forget</span>: <span class="title function_">hasMemoCache</span>(fiber),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getContextRender = (</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">Function</span>,</span><br><span class="line">): <span class="title class_">Render</span> | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">changes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Change</span>&gt; = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">traverseContexts</span>(fiber, <span class="function">(<span class="params">prevContext, nextContext</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prevValue = prevContext.<span class="property">memoizedValue</span>;</span><br><span class="line">    <span class="keyword">const</span> nextValue = nextContext.<span class="property">memoizedValue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">change</span>: <span class="title class_">Change</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      prevValue,</span><br><span class="line">      nextValue,</span><br><span class="line">      <span class="attr">unstable</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    changes.<span class="title function_">push</span>(change);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevValueString = <span class="title function_">fastSerialize</span>(prevValue);</span><br><span class="line">    <span class="keyword">const</span> nextValueString = <span class="title function_">fastSerialize</span>(nextValue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      unstableTypes.<span class="title function_">includes</span>(<span class="keyword">typeof</span> prevValue) &amp;&amp;</span><br><span class="line">      unstableTypes.<span class="title function_">includes</span>(<span class="keyword">typeof</span> nextValue) &amp;&amp;</span><br><span class="line">      prevValueString === nextValueString</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 如果是对象类型，则比较其序列化结果</span></span><br><span class="line">      <span class="comment">// 如果序列化结果比较值是相同，则说明其实该 re-render 是没必要的，通过 unstable 属性进行标记</span></span><br><span class="line">      change.<span class="property">unstable</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!result) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; selfTime &#125; = <span class="title function_">getTimings</span>(fiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;context&#x27;</span>,</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">trigger</span>: <span class="literal">false</span>,</span><br><span class="line">    changes,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">getDisplayName</span>(<span class="keyword">type</span>),</span><br><span class="line">    <span class="attr">time</span>: selfTime,</span><br><span class="line">    <span class="attr">forget</span>: <span class="title function_">hasMemoCache</span>(fiber),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getTimings = (</span><br><span class="line">  <span class="attr">fiber</span>?: <span class="title class_">Fiber</span> | <span class="literal">null</span> | <span class="literal">undefined</span>,</span><br><span class="line">): &#123; <span class="attr">selfTime</span>: <span class="built_in">number</span>; <span class="attr">totalTime</span>: <span class="built_in">number</span> &#125; =&gt; &#123;</span><br><span class="line">  <span class="comment">// fiberNode 的 actualDuration 属性表示该节点及其子节点在一次渲染中的实际渲染时间</span></span><br><span class="line">  <span class="keyword">const</span> totalTime = fiber?.<span class="property">actualDuration</span> ?? <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> selfTime = totalTime;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> child = fiber?.<span class="property">child</span> ?? <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 减去子节点的耗时</span></span><br><span class="line">  <span class="keyword">while</span> (totalTime &gt; <span class="number">0</span> &amp;&amp; child != <span class="literal">null</span>) &#123;</span><br><span class="line">    selfTime -= child.<span class="property">actualDuration</span> ?? <span class="number">0</span>;</span><br><span class="line">    child = child.<span class="property">sibling</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; selfTime, totalTime &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在上述代码中，React-scan 检测 props 和 context 更新时，通过 unstable 属性来标记了哪些更新是没必要的，在后续的可视化环节会重点绘制这些更新。</p>
<p>在接入方式上，React-scan 不仅支持通过 npm 包和 cdn script 的方式手动引入上述运行时代码，同时也支持通过命令行的方式来直接测试某个 URL 地址(参考安装使用环节的介绍)。在使用命令行时，React-scan 则通过 <a target="_blank" rel="noopener" href="https://playwright.dev/java/">playwright</a> 这个端到端测试开发框架提供的 API 来完成了 React-scan 运行时脚本的植入以及浏览器环境的控制与访问，核心概要代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  chromium,</span><br><span class="line">  devices,</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">Browser</span>,</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">BrowserContext</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;playwright&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">init</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">intro</span>(<span class="string">`<span class="subst">$&#123;bgMagenta(<span class="string">&#x27;[·]&#x27;</span>)&#125;</span> React Scan`</span>);</span><br><span class="line">  <span class="keyword">const</span> args = <span class="title function_">mri</span>(process.<span class="property">argv</span>.<span class="title function_">slice</span>(<span class="number">2</span>));</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">browser</span>: <span class="title class_">Browser</span> | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> device = devices[args.<span class="property">device</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> contextOptions = &#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">    channel,</span><br><span class="line">    ...device,</span><br><span class="line">    <span class="attr">acceptDownloads</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">viewport</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">locale</span>: <span class="string">&#x27;en-US&#x27;</span>,</span><br><span class="line">    <span class="attr">timezoneId</span>: <span class="string">&#x27;America/New_York&#x27;</span>,</span><br><span class="line">    <span class="attr">args</span>: [</span><br><span class="line">      <span class="string">&#x27;--enable-webgl&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--use-gl=swiftshader&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--enable-accelerated-2d-canvas&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--disable-blink-features=AutomationControlled&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--disable-web-security&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">userAgent</span>:</span><br><span class="line">      userAgentStrings[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * userAgentStrings.<span class="property">length</span>)],</span><br><span class="line">    <span class="attr">bypassCSP</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">ignoreHTTPSErrors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  browser = <span class="keyword">await</span> chrome.<span class="title function_">launch</span>(&#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">channel</span>: <span class="string">&#x27;chrome&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = <span class="keyword">await</span> browser.<span class="title function_">newContext</span>(contextOptions);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> context.<span class="title function_">addInitScript</span>(&#123;</span><br><span class="line">    <span class="attr">content</span>: <span class="string">`(() =&gt; &#123;</span></span><br><span class="line"><span class="string">      const NO_OP = () =&gt; &#123;&#125;;</span></span><br><span class="line"><span class="string">      let i = 0;</span></span><br><span class="line"><span class="string">      globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__ = &#123;</span></span><br><span class="line"><span class="string">        checkDCE: NO_OP,</span></span><br><span class="line"><span class="string">        supportsFiber: true,</span></span><br><span class="line"><span class="string">        renderers: new Map(),</span></span><br><span class="line"><span class="string">        onScheduleFiberRoot: NO_OP,</span></span><br><span class="line"><span class="string">        onCommitFiberRoot: NO_OP,</span></span><br><span class="line"><span class="string">        onCommitFiberUnmount: NO_OP,</span></span><br><span class="line"><span class="string">        inject(renderer) &#123;</span></span><br><span class="line"><span class="string">          const nextID = ++i;</span></span><br><span class="line"><span class="string">          this.renderers.set(nextID, renderer);</span></span><br><span class="line"><span class="string">          return nextID;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">      &#125;;</span></span><br><span class="line"><span class="string">    &#125;)();`</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> context.<span class="title function_">newPage</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * auto.global.js 的内容即为</span></span><br><span class="line"><span class="comment">   * import &#x27;bippy&#x27;;</span></span><br><span class="line"><span class="comment">     import &#123; scan &#125; from &#x27;./index&#x27;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     if (typeof window !== &#x27;undefined&#x27;) &#123;</span></span><br><span class="line"><span class="comment">       scan();</span></span><br><span class="line"><span class="comment">       window.reactScan = scan;</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> scriptContent = fs.<span class="title function_">readFileSync</span>(</span><br><span class="line">    path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./auto.global.js&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inputUrl = args.<span class="property">_</span>[<span class="number">0</span>] || <span class="string">&#x27;about:blank&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">goto</span>(inputUrl);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">pollReport</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (page.<span class="title function_">url</span>() !== currentURL) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> globalHook = globalThis.<span class="property">__REACT_SCAN__</span>;</span><br><span class="line">      <span class="keyword">if</span> (!globalHook) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">const</span> reportData = globalHook.<span class="property">ReactScanInternals</span>.<span class="property">reportData</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title class_">Object</span>.<span class="title function_">keys</span>(reportData).<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> componentName <span class="keyword">in</span> reportData) &#123;</span><br><span class="line">        count += reportData[componentName].<span class="property">count</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;REACT_SCAN_REPORT&#x27;</span>, count);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">currentSpinner</span>: <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> spinner&gt; | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">let</span> currentURL = inputUrl;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">interval</span>:<span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> <span class="built_in">setInterval</span>&gt;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 植入 React-scan 运行时</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">inject</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">url</span>: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (interval) <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">    currentURL = url;</span><br><span class="line">    <span class="keyword">const</span> truncatedURL = <span class="title function_">truncateString</span>(url, <span class="number">50</span>);</span><br><span class="line">    currentSpinner?.<span class="title function_">stop</span>(<span class="string">`<span class="subst">$&#123;truncatedURL&#125;</span><span class="subst">$&#123;count ? <span class="string">` (×<span class="subst">$&#123;count&#125;</span>)`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>);</span><br><span class="line">    currentSpinner = <span class="title function_">spinner</span>();</span><br><span class="line">    currentSpinner.<span class="title function_">start</span>(<span class="title function_">dim</span>(<span class="string">`Scanning: <span class="subst">$&#123;truncatedURL&#125;</span>`</span>));</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> page.<span class="title function_">waitForLoadState</span>(<span class="string">&#x27;load&#x27;</span>);</span><br><span class="line">      <span class="keyword">await</span> page.<span class="title function_">waitForTimeout</span>(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> hasReactScan = <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Boolean</span>(globalThis.<span class="property">__REACT_SCAN__</span>);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!hasReactScan) &#123;</span><br><span class="line">        <span class="comment">// 植入脚本</span></span><br><span class="line">        <span class="keyword">await</span> page.<span class="title function_">addScriptTag</span>(&#123;</span><br><span class="line">          <span class="attr">content</span>: scriptContent,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> page.<span class="title function_">waitForTimeout</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> globalThis.<span class="property">reactScan</span> !== <span class="string">&#x27;function&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line">        globalThis.<span class="title function_">reactScan</span>(&#123; <span class="attr">report</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">        globalThis.<span class="property">__REACT_SCAN__</span>.<span class="property">ReactScanInternals</span>.<span class="property">reportData</span> = &#123;&#125;;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 轮询数据报告</span></span><br><span class="line">        <span class="title function_">pollReport</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      currentSpinner?.<span class="title function_">stop</span>(<span class="title function_">red</span>(<span class="string">`Error: <span class="subst">$&#123;truncatedURL&#125;</span>`</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">inject</span>(inputUrl);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 检测跳转到新页面时，在新页面也植入 React-scan 脚本</span></span><br><span class="line">  page.<span class="title function_">on</span>(<span class="string">&#x27;framenavigated&#x27;</span>, <span class="title function_">async</span> (frame) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (frame !== page.<span class="title function_">mainFrame</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">const</span> url = frame.<span class="title function_">url</span>();</span><br><span class="line">    <span class="title function_">inject</span>(url);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 探测执行 console.log 时，打印出 React-scan 的检测数据</span></span><br><span class="line">  page.<span class="title function_">on</span>(<span class="string">&#x27;console&#x27;</span>, <span class="title function_">async</span> (msg) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> text = msg.<span class="title function_">text</span>();</span><br><span class="line">    <span class="keyword">if</span> (!text.<span class="title function_">startsWith</span>(<span class="string">&#x27;REACT_SCAN_REPORT&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reportDataString = text.<span class="title function_">replace</span>(<span class="string">&#x27;REACT_SCAN_REPORT&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">trim</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      count = <span class="built_in">parseInt</span>(reportDataString, <span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> truncatedURL = <span class="title function_">truncateString</span>(currentURL, <span class="number">50</span>);</span><br><span class="line">    <span class="keyword">if</span> (currentSpinner) &#123;</span><br><span class="line">      currentSpinner.<span class="title function_">message</span>(</span><br><span class="line">        <span class="title function_">dim</span>(<span class="string">`Scanning: <span class="subst">$&#123;truncatedURL&#125;</span><span class="subst">$&#123;count ? <span class="string">` (×<span class="subst">$&#123;count&#125;</span>)`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>至此，React-scan 完成了获取组件渲染数据这个关键的第一步，下一步则是进行数据可视化，通过视觉处理让开发者能够高效的感知到组件渲染的性能问题。</p>
<h3 id="可视化呈现数据"><a href="#可视化呈现数据" class="headerlink" title="可视化呈现数据"></a>可视化呈现数据</h3><p>从效果展示中可以看出 React-scan 会将组件每次更新的渲染信息通过边框（outline）的形式绘制在对应的 dom 元素上，以可视化的展示具体是哪个组件发生了更新以及具体的渲染次数和渲染耗时分别是多少。那么绘制的第一步便是先获取组件 fiberNode 所对应的 dom 元素及其矩形 box 信息。关键概要代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getOutline = (</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">Render</span>,</span><br><span class="line">): <span class="title class_">PendingOutline</span> | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 遍历组件下的 fiberNode 找到组件对应的根 dom 元素的 fiberNode</span></span><br><span class="line">  <span class="keyword">const</span> domFiber = <span class="title function_">getNearestHostFiber</span>(fiber);</span><br><span class="line">  <span class="keyword">if</span> (!domFiber) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 通过 fiberNode 的 stateNode 属性获取具体的 dom 元素</span></span><br><span class="line">  <span class="keyword">const</span> domNode = domFiber.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(domNode <span class="keyword">instanceof</span> <span class="title class_">HTMLElement</span>)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 获取该 dom 元素的矩形 box 信息</span></span><br><span class="line">  <span class="keyword">const</span> rect = <span class="title function_">getRect</span>(domNode);</span><br><span class="line">  <span class="keyword">if</span> (!rect) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    rect,</span><br><span class="line">    domNode,</span><br><span class="line">    <span class="attr">renders</span>: [render],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getRect = (<span class="attr">domNode</span>: <span class="title class_">Element</span>): <span class="title class_">DOMRect</span> | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> now = performance.<span class="title function_">now</span>();</span><br><span class="line">  <span class="keyword">const</span> cached = rectCache.<span class="title function_">get</span>(domNode);</span><br><span class="line">  <span class="comment">// 避免重复计算或频繁计算</span></span><br><span class="line">  <span class="keyword">if</span> (cached &amp;&amp; now - cached.<span class="property">timestamp</span> &lt; <span class="variable constant_">DEFAULT_THROTTLE_TIME</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cached.<span class="property">rect</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> style = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(domNode);</span><br><span class="line">  <span class="comment">// 判断当前元素在页面中是否正常展示</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    style.<span class="property">display</span> === <span class="string">&#x27;none&#x27;</span> ||</span><br><span class="line">    style.<span class="property">visibility</span> === <span class="string">&#x27;hidden&#x27;</span> ||</span><br><span class="line">    style.<span class="property">opacity</span> === <span class="string">&#x27;0&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rect = domNode.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isVisible =</span><br><span class="line">    rect.<span class="property">bottom</span> &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    rect.<span class="property">right</span> &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    rect.<span class="property">top</span> &lt; <span class="variable language_">window</span>.<span class="property">innerHeight</span> &amp;&amp;</span><br><span class="line">    rect.<span class="property">left</span> &lt; <span class="variable language_">window</span>.<span class="property">innerWidth</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isVisible || !rect.<span class="property">width</span> || !rect.<span class="property">height</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rectCache.<span class="title function_">set</span>(domNode, &#123; rect, <span class="attr">timestamp</span>: now &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rect;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>完成第一步之后，React-scan 使用了 canvas 进行渲染信息的绘制，核心概要代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> paintOutlines = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">ctx</span>: <span class="title class_">CanvasRenderingContext2D</span> | <span class="title class_">OffscreenCanvasRenderingContext2D</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">outlines</span>: <span class="title class_">Array</span>&lt;<span class="title class_">PendingOutline</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> activeOutlines = outlines.<span class="title function_">map</span>(<span class="function">(<span class="params">outline</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> renders = outline.<span class="property">renders</span>;</span><br><span class="line">      <span class="keyword">const</span> frame = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        outline,</span><br><span class="line">        <span class="attr">alpha</span>: <span class="number">0.8</span>,</span><br><span class="line">        resolve,</span><br><span class="line">        <span class="comment">// 组装渲染次数与耗时的文案</span></span><br><span class="line">        <span class="attr">text</span>: <span class="title function_">getLabelText</span>(renders),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      ctx.<span class="title function_">clearRect</span>(<span class="number">0</span>, <span class="number">0</span>, ctx.<span class="property">canvas</span>.<span class="property">width</span> / dpi, ctx.<span class="property">canvas</span>.<span class="property">height</span> / dpi);</span><br><span class="line">      <span class="comment">// 优先绘制栈顶数据</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = activeOutlines.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">const</span> activeOutline = activeOutlines[i];</span><br><span class="line">        <span class="keyword">if</span> (!activeOutline) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">const</span> &#123; outline, text &#125; = activeOutline;</span><br><span class="line">        <span class="keyword">const</span> &#123; rect &#125; = outline;</span><br><span class="line">        <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;rect.x&#125;</span>-<span class="subst">$&#123;rect.y&#125;</span>`</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消费前面提过的 unstable 属性</span></span><br><span class="line">        <span class="keyword">const</span> isImportant = <span class="title function_">isOutlineUnstable</span>(outline);</span><br><span class="line">        <span class="comment">// 通过透明度来重点标记不必要的 re-render</span></span><br><span class="line">        <span class="keyword">const</span> alphaScalar = isImportant ? <span class="number">0.8</span> : <span class="number">0.2</span>;</span><br><span class="line"></span><br><span class="line">        ctx.<span class="title function_">save</span>();</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        <span class="comment">// 根据对应 dom 元素的坐标和宽高绘制 dom 的边框矩形到 canvas 上</span></span><br><span class="line">        ctx.<span class="title function_">rect</span>(rect.<span class="property">x</span>, rect.<span class="property">y</span>, rect.<span class="property">width</span>, rect.<span class="property">height</span>);</span><br><span class="line">        ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line"></span><br><span class="line">        ctx.<span class="title function_">restore</span>();</span><br><span class="line">        <span class="comment">// 绘制对应 dom 渲染信息的文案, 渲染了多少次以及耗时多久</span></span><br><span class="line">        <span class="keyword">if</span> (text) &#123;</span><br><span class="line">          ctx.<span class="property">font</span> = <span class="string">`11px Menlo,Consolas,Monaco,Liberation Mono,Lucida Console,monospace`</span>;</span><br><span class="line">          <span class="keyword">const</span> textMetrics = ctx.<span class="title function_">measureText</span>(text);</span><br><span class="line">          <span class="keyword">const</span> textWidth = textMetrics.<span class="property">width</span>;</span><br><span class="line">          <span class="keyword">const</span> textHeight = <span class="number">11</span>;</span><br><span class="line">          <span class="comment">// 文案的横坐标与 dom 矩形一致</span></span><br><span class="line">          <span class="keyword">const</span> <span class="attr">labelX</span>: <span class="built_in">number</span> = rect.<span class="property">x</span>;</span><br><span class="line">          <span class="comment">// 文案的纵坐标放置在 dom 矩形上方</span></span><br><span class="line">          <span class="keyword">const</span> <span class="attr">labelY</span>: <span class="built_in">number</span> = rect.<span class="property">y</span> - textHeight - <span class="number">4</span>;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 绘制文本的矩形边框</span></span><br><span class="line">          ctx.<span class="title function_">fillRect</span>(labelX, labelY, textWidth + <span class="number">4</span>, textHeight + <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">          ctx.<span class="property">fillStyle</span> = <span class="string">`rgba(255,255,255,<span class="subst">$&#123;alpha&#125;</span>)`</span>;</span><br><span class="line">          <span class="comment">// 绘制文本本身</span></span><br><span class="line">          ctx.<span class="title function_">fillText</span>(text, labelX + <span class="number">2</span>, labelY + textHeight);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.<span class="title function_">restore</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该绘制所用的 canvas 为 React-scan 在初始化时创建，React-scan 创建了一个自定义元素，并且在创建过程中的处理非常严谨，为了防止横屏或者滚动时页面布局发生变化，也监听了相关事件并重新计算了 canvas 的宽高以及元素的 outline。核心代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">initReactScanOverlay</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReactScanOverlay</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span><br><span class="line">    <span class="attr">canvas</span>: <span class="title class_">HTMLCanvasElement</span>;</span><br><span class="line">    <span class="comment">// @ts-expect-error will be defined</span></span><br><span class="line">    <span class="attr">ctx</span>: <span class="title class_">CanvasRenderingContext2D</span> | <span class="title class_">OffscreenCanvasRenderingContext2D</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">super</span>();</span><br><span class="line">      <span class="comment">// 创建一个 shadow dom 来添加 canvas，避免影响外部文档结构</span></span><br><span class="line">      <span class="keyword">const</span> shadow = <span class="variable language_">this</span>.<span class="title function_">attachShadow</span>(&#123; <span class="attr">mode</span>: <span class="string">&#x27;open&#x27;</span> &#125;);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setupCanvas</span>();</span><br><span class="line"></span><br><span class="line">      shadow.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">getContext</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setupCanvas</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">id</span> = <span class="string">&#x27;react-scan-canvas&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;fixed&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&#x27;100vw&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&#x27;100vh&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">pointerEvents</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">zIndex</span> = <span class="string">&#x27;2147483646&#x27;</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">setAttribute</span>(<span class="string">&#x27;aria-hidden&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> isOffscreenCanvasSupported = <span class="string">&#x27;OffscreenCanvas&#x27;</span> <span class="keyword">in</span> globalThis;</span><br><span class="line">      <span class="keyword">const</span> offscreenCanvas = isOffscreenCanvasSupported</span><br><span class="line">        ? <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">transferControlToOffscreen</span>()</span><br><span class="line">        : <span class="variable language_">this</span>.<span class="property">canvas</span>;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ctx</span> = offscreenCanvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>) <span class="keyword">as</span></span><br><span class="line">        | <span class="title class_">OffscreenCanvasRenderingContext2D</span></span><br><span class="line">        | <span class="title class_">CanvasRenderingContext2D</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> resizeScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">resize</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> dpi = <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span> || <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span> = dpi * <span class="variable language_">window</span>.<span class="property">innerWidth</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span> = dpi * <span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">width</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">window</span>.innerWidth&#125;</span>px`</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="string">`<span class="subst">$&#123;<span class="variable language_">window</span>.innerHeight&#125;</span>px`</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">resetTransform</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">scale</span>(dpi, dpi);</span><br><span class="line"></span><br><span class="line">        resizeScheduled = <span class="literal">false</span>;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">resize</span>();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 页面 resize 或滚动时重新计算元素的 outline</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">recalcOutlines</span>();</span><br><span class="line">        <span class="keyword">if</span> (!resizeScheduled) &#123;</span><br><span class="line">          resizeScheduled = <span class="literal">true</span>;</span><br><span class="line">          <span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">resize</span>();</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">recalcOutlines</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建一个自定义元素</span></span><br><span class="line">  customElements.<span class="title function_">define</span>(<span class="string">&#x27;react-scan-overlay&#x27;</span>, <span class="title class_">ReactScanOverlay</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">ReactScanOverlay</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>至此，React-scan 也完成了渲染数据可视化的第二步，除了上述最核心的基础能力外，React-scan 也提供了一些额外的能力，包括可视化的工具栏来展示具体的渲染原因以及自定义监控和组件白名单过滤等能力，这里不再详细展开。</p>
<h2 id="使用的注意事项"><a href="#使用的注意事项" class="headerlink" title="使用的注意事项"></a>使用的注意事项</h2><p>React-scan 项目本身并没有提到任何使用的注意事项，但其依赖的核心库 bippy 却是值得关注的，其 warning 如下：<br><img src="https://img.alicdn.com/imgextra/i3/O1CN018BCSAi1MV6y9ZKlm3_!!6000000001439-0-tps-863-192.jpg"><br>解释一下，由于切入到了 React 内部的运行机制，bippy 可能会给应用造成一些预期之外的影响。同时，由于 React 内部运行机制可能会随着版本迭代有所变化，所以 bippy 也不能保证其能一直有效。换言之，其实并不建议在生产环境使用 React-scan, 可以在本地调试的过程中通过该工具来帮你发现和定位一些性能问题。</p>
<h2 id="有了-React-Compiler-之后还需要-React-scan-吗？"><a href="#有了-React-Compiler-之后还需要-React-scan-吗？" class="headerlink" title="有了 React Compiler 之后还需要 React-scan 吗？"></a>有了 React Compiler 之后还需要 React-scan 吗？</h2><p>先说答案，当然是需要。React-compiler 解决的问题是让开发者不再需要去关注组件内的重复计算问题，不再需要手动通过 memo, useMemo 或 useCallback 来缓存组件和组件内的计算结果。可以说，有了 React compiler 以后，我们 React 应用的性能问题将会减少很多，但一些常见 case 仍无法避免，比如说像下面这种写法：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ExpensiveComponent</span> onClick=&#123;<span class="function">() =&gt;</span> <span class="title function_">alert</span>(<span class="string">&#x27;hi&#x27;</span>)&#125; style=&#123;&#123; <span class="attr">color</span>: <span class="string">&#x27;purple&#x27;</span> &#125;&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>由于 props 比较的是引用，对于 <code>ExpensiveComponent</code> 这个组件来说，每次其父组件 re-render 时，其 onClick 属性和 style 属性都会是一个新创建的对象，但其实对象内容并没有什么本质变化，此时，<code>ExpensiveComponent</code> 就会触发多余的 re-render，而 React-scan 则可以帮助我们去发现此类问题。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从实现原理来说，React-scan 与 React Devtools 并没有什么本质的差别，都是通过植入自定义的 <code>__REACT_DEVTOOLS_GLOBAL_HOOK__</code> 对象来切入到 React 内部获取相关的渲染数据，然后进行数据可视化的呈现，但 React-scan 在技术产品化方面做的更好，它借鉴了一些已有工具的设计，与此同时，它在其基础上补足了相应的短板，在易用性（接入成本低），灵活性（提供可编程 api）以及问题排查效率（自动标记哪些是无必要更新）等方面均做了很多工作。此外，React-scan 的 roadmap 也显示出它是一个野心勃勃的项目，未来会支持更多性能类型的检测，比如页面加载，FPS 等，以及更多渲染类型的检测，比如 React Native.</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#React,Performance" >
    <span class="tag-code">React,Performance</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2024/12/01/qwik/">
        <span class="nav-arrow">← </span>
        
          追求极致性能的框架 - Qwik
        
      </a>
    
    
      <a class="nav-right" href="/2025/05/30/vinenote/">
        
          VineNote
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo="NealST/NealST.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8"><span class="toc-nav-text">安装使用</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E6%8E%A5%E5%85%A5"><span class="toc-nav-text">编程式接入</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8"><span class="toc-nav-text">命令行使用</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-nav-text">效果展示</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-text">实现原理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%8E%B7%E5%8F%96%E6%B8%B2%E6%9F%93%E6%95%B0%E6%8D%AE"><span class="toc-nav-text">获取渲染数据</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E5%91%88%E7%8E%B0%E6%95%B0%E6%8D%AE"><span class="toc-nav-text">可视化呈现数据</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-nav-text">使用的注意事项</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%9C%89%E4%BA%86-React-Compiler-%E4%B9%8B%E5%90%8E%E8%BF%98%E9%9C%80%E8%A6%81-React-scan-%E5%90%97%EF%BC%9F"><span class="toc-nav-text">有了 React Compiler 之后还需要 React-scan 吗？</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-text">总结</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://nealst.github.io/2025/01/27/react-scan/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2026 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
    
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>